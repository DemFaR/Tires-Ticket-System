<!DOCTYPE html>
<html>
<head>
    <title>Final File Upload Fix Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 2px solid #ccc; border-radius: 8px; }
        .file-upload-area { border: 2px dashed #bdc3c7; padding: 20px; text-align: center; margin: 10px 0; }
        .file-preview { border: 1px solid #ddd; margin: 10px 0; padding: 10px; min-height: 50px; }
        .file-preview-item { 
            display: flex; 
            align-items: center; 
            margin: 5px 0; 
            padding: 10px; 
            border: 1px solid #eee; 
            background: #f9f9f9;
            border-radius: 4px;
        }
        .file-preview-item img { 
            max-width: 60px; 
            max-height: 60px; 
            margin-right: 15px; 
            border-radius: 4px;
        }
        .file-name { 
            flex: 1; 
            margin: 0 15px; 
            font-weight: bold; 
            word-break: break-all;
        }
        .file-remove { 
            background: #e74c3c; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 25px; 
            height: 25px; 
            cursor: pointer; 
            font-size: 14px;
        }
        .file-remove:hover { background: #c0392b; }
        .debug-info { 
            background: #ecf0f1; 
            padding: 15px; 
            margin: 10px 0; 
            font-family: monospace; 
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .success { color: #27ae60; font-weight: bold; }
        .error { color: #e74c3c; font-weight: bold; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîß File Upload Duplication Fix - Final Test</h1>
    
    <div class="test-section">
        <h2>‚úÖ Test 1: Tire Images (Multiple)</h2>
        <input type="file" id="tire_images" multiple accept="image/*">
        <div id="tire-images-preview" class="file-preview"></div>
    </div>

    <div class="test-section">
        <h2>‚úÖ Test 2: Receipt/Invoice (Single)</h2>
        <input type="file" id="receipt_image" accept="image/*,.pdf">
        <div id="receipt-preview" class="file-preview"></div>
    </div>

    <div class="test-section">
        <h2>‚úÖ Test 3: Additional Documents (Multiple + Various Types)</h2>
        <input type="file" id="additional_files" multiple accept="image/*,.pdf,.doc,.docx,.txt,.rtf,.odt">
        <div id="additional-files-preview" class="file-preview"></div>
    </div>

    <div id="debug-output" class="debug-info">Ready for testing...</div>

    <script>
    jQuery(document).ready(function($) {
        var debugOutput = $('#debug-output');
        
        function addDebug(message) {
            var timestamp = new Date().toLocaleTimeString();
            debugOutput.append('[' + timestamp + '] ' + message + '\n');
            debugOutput.scrollTop(debugOutput[0].scrollHeight);
        }
        
        // FIXED FILE UPLOAD PREVIEWS - Using Array.forEach to avoid closure issues
        function setupFilePreview(inputId, previewId) {
            $(document).on('change', '#' + inputId, function() {
                var files = this.files;
                var preview = $('#' + previewId);
                preview.empty();
                
                addDebug('üìÅ Processing ' + files.length + ' files for input: ' + inputId);
                
                // Convert FileList to Array to avoid reference issues
                var fileArray = Array.prototype.slice.call(files);
                
                fileArray.forEach(function(file, index) {
                    addDebug('  üìÑ File ' + (index + 1) + ': ' + file.name + ' (' + file.type + ')');
                    
                    var reader = new FileReader();
                    
                    reader.onload = function(e) {
                        addDebug('  ‚úÖ Loaded preview for: ' + file.name);
                        
                        var previewItem = $('<div class="file-preview-item">');
                        
                        if (file.type.startsWith('image/')) {
                            previewItem.append('<img src="' + e.target.result + '" alt="Preview">');
                        } else {
                            previewItem.append('<div style="font-size: 24px;">üìÑ</div>');
                        }
                        
                        previewItem.append('<div class="file-name">' + file.name + '</div>');
                        previewItem.append('<button type="button" class="file-remove" data-filename="' + file.name + '" data-input-id="' + inputId + '">&times;</button>');
                        
                        preview.append(previewItem);
                    };
                    
                    reader.onerror = function() {
                        addDebug('  ‚ùå Error loading: ' + file.name);
                    };
                    
                    reader.readAsDataURL(file);
                });
            });
        }
        
        setupFilePreview('tire_images', 'tire-images-preview');
        setupFilePreview('receipt_image', 'receipt-preview');
        setupFilePreview('additional_files', 'additional-files-preview');
        
        // ENHANCED REMOVE FILE PREVIEW
        $(document).on('click', '.file-remove', function() {
            var previewItem = $(this).parent();
            var filename = $(this).data('filename');
            var inputId = $(this).data('input-id');
            var previewContainer = previewItem.closest('.file-preview');
            
            addDebug('üóëÔ∏è Removing file: ' + filename + ' from input: ' + inputId);
            
            // Remove the preview item
            previewItem.remove();
            
            // If this was the only preview item, clear the input
            if (previewContainer.children().length === 0 && inputId) {
                var input = $('#' + inputId)[0];
                if (input) {
                    input.value = '';
                    addDebug('  üßπ Cleared input: ' + inputId);
                }
            }
        });
        
        addDebug('üöÄ File upload system initialized with forEach-based processing');
        addDebug('üìù Instructions: Select multiple files with different names to test');
    });
    </script>
    
    <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #e8f5e8, #f0f8ff); border-radius: 8px;">
        <h3>üéØ Test Cases to Verify:</h3>
        <ol>
            <li><strong>Unique Filenames:</strong> Select 2-3 files with different names - each should show its actual name</li>
            <li><strong>File Type Support:</strong> Try images, PDFs, Word docs, text files</li>
            <li><strong>Remove Functionality:</strong> Click X to remove files - should remove specific file</li>
            <li><strong>No Duplication:</strong> Each file preview should be unique, no identical names</li>
        </ol>
        
        <h3>‚úÖ Expected Results:</h3>
        <ul>
            <li><span class="success">‚úì</span> Each file shows its unique, correct filename</li>
            <li><span class="success">‚úì</span> File previews match selected files</li>
            <li><span class="success">‚úì</span> Remove buttons work correctly</li>
            <li><span class="success">‚úì</span> No file name duplication occurs</li>
            <li><span class="success">‚úì</span> Debug log shows correct file processing</li>
        </ul>
        
        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px;">
            <strong>üîç Technical Fix Applied:</strong><br>
            ‚Ä¢ Replaced for-loop + IIFE with Array.forEach to eliminate closure issues<br>
            ‚Ä¢ Added proper file array conversion to avoid FileList reference problems<br>
            ‚Ä¢ Enhanced debug logging to track file processing<br>
            ‚Ä¢ Improved remove functionality with data attributes
        </div>
    </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>Debug File Duplication Issue</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .file-preview { border: 1px solid #ddd; margin: 10px 0; padding: 10px; }
        .file-preview-item { 
            display: flex; 
            align-items: center; 
            margin: 5px 0; 
            padding: 5px; 
            border: 1px solid #eee; 
            background: #f9f9f9;
        }
        .file-preview-item img { max-width: 50px; max-height: 50px; margin-right: 10px; }
        .file-name { flex: 1; margin: 0 10px; font-weight: bold; }
        .file-remove { 
            background: red; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            cursor: pointer; 
        }
        .debug-info { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>File Duplication Debug Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Simple Multiple File Upload</h2>
        <input type="file" id="test_files" multiple accept="image/*">
        <div id="test-preview" class="file-preview"></div>
        <div id="debug-info-1" class="debug-info"></div>
    </div>

    <script>
    jQuery(document).ready(function($) {
        function debugFilePreview(inputId, previewId, debugId) {
            $(document).on('change', '#' + inputId, function() {
                var files = this.files;
                var preview = $('#' + previewId);
                var debug = $('#' + debugId);
                
                debug.html('Files selected: ' + files.length + '<br>');
                preview.empty();
                
                // Log all filenames first
                for (var i = 0; i < files.length; i++) {
                    debug.append('File ' + i + ': ' + files[i].name + '<br>');
                }
                debug.append('<br>Processing files...<br>');
                
                for (var i = 0; i < files.length; i++) {
                    debug.append('Starting process for file index: ' + i + '<br>');
                    
                    // Method 1: IIFE (should work)
                    (function(file, index) {
                        debug.append('IIFE: Processing ' + file.name + ' (index: ' + index + ')<br>');
                        
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            debug.append('FileReader loaded for: ' + file.name + '<br>');
                            
                            var previewItem = $('<div class="file-preview-item">');
                            
                            if (file.type.startsWith('image/')) {
                                previewItem.append('<img src="' + e.target.result + '" alt="Preview">');
                            } else {
                                previewItem.append('<div>ðŸ“„</div>');
                            }
                            
                            previewItem.append('<div class="file-name">' + file.name + '</div>');
                            previewItem.append('<button type="button" class="file-remove" data-filename="' + file.name + '">&times;</button>');
                            
                            preview.append(previewItem);
                        };
                        
                        reader.readAsDataURL(file);
                    })(files[i], i);
                }
            });
        }
        
        debugFilePreview('test_files', 'test-preview', 'debug-info-1');
        
        // Remove file preview
        $(document).on('click', '.file-remove', function() {
            var filename = $(this).data('filename');
            console.log('Removing file:', filename);
            $(this).parent().remove();
        });
    });
    </script>
    
    <div style="margin-top: 30px; padding: 20px; background: #fffacd;">
        <h3>Test Instructions:</h3>
        <ol>
            <li>Select 2-3 different image files with different names</li>
            <li>Check if each preview shows the correct filename</li>
            <li>Look at the debug information to see the processing flow</li>
        </ol>
        
        <h3>Expected Results:</h3>
        <ul>
            <li>Each file should show its unique name</li>
            <li>Debug info should show correct file names being processed</li>
            <li>No file duplication should occur</li>
        </ul>
    </div>
</body>
</html>

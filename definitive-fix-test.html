<!DOCTYPE html>
<html>
<head>
    <title>Definitive File Duplication Fix Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 30px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; }
        .file-upload-area { 
            border: 2px dashed #bdc3c7; 
            padding: 20px; 
            text-align: center; 
            margin: 10px 0; 
            border-radius: 6px;
            position: relative;
        }
        .file-upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .file-preview { 
            margin: 15px 0; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 10px; 
        }
        .file-preview-item { 
            background: #f8f9fa; 
            border: 1px solid #e1e5e9; 
            border-radius: 4px; 
            padding: 10px; 
            text-align: center; 
            position: relative;
        }
        .file-preview-item img { 
            max-width: 100%; 
            max-height: 80px; 
            border-radius: 4px; 
        }
        .file-name { 
            font-size: 12px; 
            margin-top: 5px; 
            word-break: break-all; 
            font-weight: bold;
            color: #2c3e50;
        }
        .file-remove { 
            position: absolute; 
            top: -5px; 
            right: -5px; 
            background: #e74c3c; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            cursor: pointer; 
            font-size: 12px;
        }
        .file-remove:hover { background: #c0392b; }
        .debug-console { 
            background: #2c3e50; 
            color: #ecf0f1; 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 4px; 
            font-family: monospace; 
            max-height: 200px; 
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .clear-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        h1 { color: #2c3e50; text-align: center; }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ DEFINITIVE File Duplication Fix Test</h1>
        
        <div class="test-section">
            <h2>Test: Multiple Image Upload</h2>
            <div class="file-upload-area">
                <input type="file" id="test_images" multiple accept="image/*">
                <p>üì∏ Click to select multiple images with DIFFERENT names</p>
                <small>Select 2-3 images to test the fix</small>
            </div>
            <div id="test-images-preview" class="file-preview"></div>
        </div>

        <button class="clear-btn" onclick="clearDebug()">Clear Debug Console</button>
        <div id="debug-console" class="debug-console">Debug console ready...\n</div>
    </div>

    <script>
    function addDebug(message) {
        const console = document.getElementById('debug-console');
        const timestamp = new Date().toLocaleTimeString();
        console.textContent += `[${timestamp}] ${message}\n`;
        console.scrollTop = console.scrollHeight;
    }
    
    function clearDebug() {
        document.getElementById('debug-console').textContent = 'Debug console cleared...\n';
    }

    jQuery(document).ready(function($) {
        addDebug('üöÄ jQuery ready - initializing file upload system');
        
        // COMPLETELY REWRITTEN file preview function
        function setupFilePreview(inputId, previewId) {
            $(document).on('change', '#' + inputId, function() {
                var files = this.files;
                var preview = $('#' + previewId);
                preview.empty();
                
                addDebug(`üìÅ Processing ${files.length} files for input: ${inputId}`);
                
                // Process each file individually with proper scope isolation
                for (let i = 0; i < files.length; i++) {
                    let currentFile = files[i];
                    let currentIndex = i;
                    
                    addDebug(`  üìÑ File ${currentIndex}: "${currentFile.name}" (${currentFile.type})`);
                    
                    // Create a new FileReader for each file
                    let reader = new FileReader();
                    
                    // Use arrow function to maintain proper scope
                    reader.onload = (function(file, index) {
                        return function(e) {
                            addDebug(`  ‚úÖ FileReader completed for: "${file.name}" (index: ${index})`);
                            
                            var previewItem = $('<div class="file-preview-item">');
                            
                            if (file.type.startsWith('image/')) {
                                previewItem.append('<img src="' + e.target.result + '" alt="Preview">');
                            } else {
                                previewItem.append('<div style="font-size: 24px;">üìÑ</div>');
                            }
                            
                            previewItem.append('<div class="file-name">' + file.name + '</div>');
                            previewItem.append('<button type="button" class="file-remove" data-filename="' + file.name + '" data-input-id="' + inputId + '">&times;</button>');
                            
                            preview.append(previewItem);
                            
                            addDebug(`  üéØ Preview created for: "${file.name}"`);
                        };
                    })(currentFile, currentIndex);
                    
                    reader.onerror = function() {
                        addDebug(`  ‚ùå Error reading file: ${currentFile.name}`);
                    };
                    
                    reader.readAsDataURL(currentFile);
                }
            });
        }
        
        setupFilePreview('test_images', 'test-images-preview');
        
        // Remove file preview
        $(document).on('click', '.file-remove', function() {
            var previewItem = $(this).parent();
            var filename = $(this).data('filename');
            var inputId = $(this).data('input-id');
            
            addDebug(`üóëÔ∏è Removing file: "${filename}" from input: ${inputId}`);
            previewItem.remove();
        });
        
        addDebug('‚úÖ File upload system initialized with let/const scope isolation');
    });
    </script>
    
    <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; border-radius: 8px;">
        <h3>üéØ Test Instructions:</h3>
        <ol>
            <li><strong>Select 2-3 different images</strong> with completely different filenames</li>
            <li><strong>Check each preview</strong> - should show the actual filename of each image</li>
            <li><strong>Watch the debug console</strong> - it shows exactly what's being processed</li>
            <li><strong>Expected Result:</strong> NO duplicate filenames in previews</li>
        </ol>
        
        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 4px;">
            <strong>üîß Technical Fix:</strong><br>
            ‚Ä¢ Used <code>let</code> instead of <code>var</code> for proper block scope<br>
            ‚Ä¢ Explicit file variable capture with arrow functions<br>
            ‚Ä¢ Individual FileReader instances for each file<br>
            ‚Ä¢ Enhanced debug logging to track processing
        </div>
    </div>
</body>
</html>
